{{define "index_content"}}
<section class="card shadow-sm mb-4">
  <div class="card-body d-flex justify-content-between align-items-center gap-3 wrap-sm">
    <div>
      <h1 class="h3 mb-1">Waitlist dashboard</h1>
      <p class="text-secondary mb-0">Park impulse purchases, wait, then decide with a clearer head.</p>
    </div>
    <div class="d-flex gap-2 wrap-sm">
      <a class="btn btn-primary" href="/items/new">Add item</a>
    </div>
  </div>
</section>

<section class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3 wrap-sm">
      <h2 class="h5 mb-0">Waitlist</h2>
      <span class="badge text-bg-secondary">{{len .Items}} / {{.TotalItems}} items</span>
    </div>

    <details class="mb-3" {{if .HasActiveFilter}}open{{end}}>
      <summary class="btn btn-outline-secondary btn-sm">Search, filter & sort</summary>
      <form method="get" action="/" class="row g-2 mt-2" data-auto-submit-filter="true">
        <div class="col-12 col-md-4">
          <label for="q" class="form-label">Search</label>
          <input id="q" name="q" class="form-control" value="{{.SearchQuery}}" placeholder="Title, note, link, tags" />
        </div>
        <fieldset class="col-12 col-md-5">
          <legend class="form-label mb-1">Status</legend>
          <div class="status-filter-group d-flex flex-wrap gap-2">
            <input class="status-filter-input" id="status-waiting" type="checkbox" name="status" value="Waiting" {{if index .SelectedStatus "Waiting"}}checked{{end}} />
            <label class="btn btn-sm status-filter-badge" for="status-waiting">Waiting</label>

            <input class="status-filter-input" id="status-ready" type="checkbox" name="status" value="Ready to buy" {{if index .SelectedStatus "Ready to buy"}}checked{{end}} />
            <label class="btn btn-sm status-filter-badge" for="status-ready">Ready to buy</label>

            <input class="status-filter-input" id="status-bought" type="checkbox" name="status" value="Bought" {{if index .SelectedStatus "Bought"}}checked{{end}} />
            <label class="btn btn-sm status-filter-badge" for="status-bought">Bought</label>

            <input class="status-filter-input" id="status-skipped" type="checkbox" name="status" value="Skipped" {{if index .SelectedStatus "Skipped"}}checked{{end}} />
            <label class="btn btn-sm status-filter-badge" for="status-skipped">Skipped</label>
          </div>
        </fieldset>
        <div class="col-6 col-md-2">
          <label for="tag" class="form-label">Tag</label>
          <input id="tag" name="tag" class="form-control" value="{{.TagFilter}}" placeholder="e.g. tech" />
        </div>
        <div class="col-12 col-md-3">
          <label for="sort" class="form-label">Sort</label>
          <select id="sort" name="sort" class="form-select">
            <option value="next_ready" {{if eq .SortBy "next_ready"}}selected{{end}}>Next ready (default)</option>
            <option value="newest" {{if eq .SortBy "newest"}}selected{{end}}>Newest first</option>
            <option value="oldest" {{if eq .SortBy "oldest"}}selected{{end}}>Oldest first</option>
            <option value="price_asc" {{if eq .SortBy "price_asc"}}selected{{end}}>Price low → high</option>
            <option value="price_desc" {{if eq .SortBy "price_desc"}}selected{{end}}>Price high → low</option>
          </select>
        </div>
        <div class="col-12 d-flex gap-2">
          <a href="/" class="btn btn-outline-secondary btn-sm">Reset</a>
        </div>
      </form>
    </details>

    {{if not .Items}}
    <p class="text-secondary mb-0">No matching entries. Adjust filters or add your first item.</p>
    {{else}}
    <ul class="list-group list-group-flush">
      {{range .Items}}
      <li class="list-group-item px-0">
        <div class="d-flex justify-content-between align-items-start gap-3 wrap-sm">
          <div>
            <p class="fw-semibold mb-1">{{.Title}}</p>
            {{if .Note}}<p class="small text-secondary mb-1">{{.Note}}</p>{{end}}
            {{if .Tags}}<p class="small text-secondary mb-1">Tags: {{.Tags}}</p>{{end}}
            {{if .Link}}<a class="small" href="{{.Link}}" target="_blank" rel="noreferrer">Open link</a>{{end}}
          </div>
          <div class="text-end">
            <span class="badge {{statusBadgeClass .Status}}">{{.Status}}</span>
            {{if .Price}}<p class="small text-secondary mb-0 mt-1">{{$.Currency}} {{.Price}}</p>{{end}}
            {{if .Price}}
            {{if workHoursAvailable . $.HourlyWage $.HasHourlyWage}}
            <p class="small text-secondary mb-0 mt-1">Work hours: {{formatWorkHours . $.HourlyWage}} h</p>
            {{else}}
            <p class="small text-secondary mb-0 mt-1">Work hours: add a valid price and hourly wage.</p>
            {{end}}
            {{end}}
            <p class="small text-secondary mb-0 mt-1">
              Buy after:
              <time class="purchase-allowed-at" datetime="{{.PurchaseAllowedAt.UTC.Format "2006-01-02T15:04:05Z07:00"}}">{{.PurchaseAllowedAt.Format "02.01.2006 15:04"}}</time>
            </p>
            <div class="item-actions mt-2">
              <a class="btn btn-sm btn-outline-primary item-action-btn" href="/items/edit?id={{.ID}}">Edit</a>
              <form method="post" action="/items/delete" class="item-status-form" onsubmit="return confirm('Delete this item permanently?');">
                <input type="hidden" name="item_id" value="{{.ID}}" />
                <button class="btn btn-sm btn-outline-danger item-action-btn" type="submit">Delete</button>
              </form>
              {{if eq .Status "Ready to buy"}}
              <form method="post" action="/items/snooze" class="item-status-form">
                <input type="hidden" name="item_id" value="{{.ID}}" />
                <button class="btn btn-sm btn-outline-secondary item-action-btn" type="submit" name="snooze_preset" value="24h">Snooze +24h</button>
              </form>
              {{end}}
              {{if eq .Status "Ready to buy"}}
              <form method="post" action="/items/status" class="item-status-form">
                <input type="hidden" name="item_id" value="{{.ID}}" />
                <button class="btn btn-sm btn-success item-action-btn" type="submit" name="status" value="Bought">Mark as bought</button>
                <button class="btn btn-sm btn-outline-secondary item-action-btn" type="submit" name="status" value="Skipped">Mark as skipped</button>
              </form>
              {{end}}
            </div>
          </div>
        </div>
      </li>
      {{end}}
    </ul>
    {{end}}
  </div>
</section>
{{end}}

{{define "index_script"}}
<script>
  (function () {
    var formatter = new Intl.DateTimeFormat(navigator.language, {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });

    document.querySelectorAll(".purchase-allowed-at").forEach(function (node) {
      var raw = node.getAttribute("datetime");
      if (!raw) {
        return;
      }

      var parsed = new Date(raw);
      if (Number.isNaN(parsed.getTime())) {
        return;
      }

      node.textContent = formatter.format(parsed);
    });

    var filterForm = document.querySelector("form[data-auto-submit-filter='true']");
    if (!filterForm) {
      return;
    }

    var debounceTimer;
    var submitFilterForm = function () {
      if (typeof filterForm.requestSubmit === "function") {
        filterForm.requestSubmit();
        return;
      }
      filterForm.submit();
    };

    filterForm.querySelectorAll("input[name='status']").forEach(function (statusInput) {
      statusInput.addEventListener("change", submitFilterForm);
    });

    ["#sort", "#tag"].forEach(function (selector) {
      var field = filterForm.querySelector(selector);
      if (!field) {
        return;
      }
      field.addEventListener("change", submitFilterForm);
    });

    var searchField = filterForm.querySelector("#q");
    if (searchField) {
      searchField.addEventListener("input", function () {
        window.clearTimeout(debounceTimer);
        debounceTimer = window.setTimeout(submitFilterForm, 250);
      });
    }
  })();
</script>
{{end}}
