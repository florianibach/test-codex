<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{.Title}}</title>
  <link href="/assets/app.css" rel="stylesheet">
</head>
<body class="bg-body-tertiary">
  <main class="container py-3 py-md-4" style="max-width: 720px;">
    <header class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h3 mb-1">Impulse Pause</h1>
        <p class="text-secondary mb-0">Leite spontane Käufe in die Warteliste um.</p>
      </div>
      <a class="btn btn-outline-secondary btn-sm" href="/about">About</a>
    </header>

    <section class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h5 card-title">Item schnell erfassen</h2>
        <p class="text-secondary small">Nur ein Titel ist Pflicht. Alles andere kannst du später ergänzen.</p>

        {{if .Error}}
        <div class="alert alert-danger py-2" role="alert">{{.Error}}</div>
        {{end}}

        <form method="post" action="/" class="vstack gap-3">
          <div>
            <label for="title" class="form-label">Titel <span class="text-danger">*</span></label>
            <input id="title" name="title" class="form-control form-control-lg" autocomplete="off" required placeholder="z. B. Neue Kopfhörer" value="{{.FormValues.Title}}" />
          </div>

          <div>
            <label for="wait_preset" class="form-label">Wartezeit</label>
            <select id="wait_preset" name="wait_preset" class="form-select">
              <option value="24h" {{if or (eq .FormValues.WaitPreset "") (eq .FormValues.WaitPreset "24h")}}selected{{end}}>24h</option>
              <option value="7d" {{if eq .FormValues.WaitPreset "7d"}}selected{{end}}>7 Tage</option>
              <option value="30d" {{if eq .FormValues.WaitPreset "30d"}}selected{{end}}>30 Tage</option>
              <option value="custom" {{if eq .FormValues.WaitPreset "custom"}}selected{{end}}>Custom</option>
            </select>
          </div>

          <div id="custom-hours-group" {{if ne .FormValues.WaitPreset "custom"}}hidden{{end}}>
            <label for="wait_custom_hours" class="form-label">Custom (Stunden)</label>
            <input id="wait_custom_hours" name="wait_custom_hours" type="number" class="form-control" placeholder="z. B. 12" value="{{.FormValues.WaitCustomHours}}" {{if ne .FormValues.WaitPreset "custom"}}disabled{{end}} />
          </div>

          <details>
            <summary class="text-primary">Optionale Felder</summary>
            <div class="pt-3 vstack gap-3">
              <div>
                <label for="price" class="form-label">Preis</label>
                <input id="price" name="price" class="form-control" placeholder="z. B. 129,99" value="{{.FormValues.Price}}" />
              </div>
              <div>
                <label for="link" class="form-label">Link</label>
                <input id="link" name="link" class="form-control" placeholder="https://..." value="{{.FormValues.Link}}" />
              </div>
              <div>
                <label for="tags" class="form-label">Tags</label>
                <input id="tags" name="tags" class="form-control" placeholder="Tech, Audio" value="{{.FormValues.Tags}}" />
              </div>
              <div>
                <label for="note" class="form-label">Notiz</label>
                <textarea id="note" name="note" class="form-control" rows="2" placeholder="Warum willst du das kaufen?">{{.FormValues.Note}}</textarea>
              </div>
            </div>
          </details>

          <button class="btn btn-primary btn-lg" type="submit">Zur Warteliste hinzufügen</button>
        </form>
      </div>
    </section>

    <section class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">Warteliste</h2>
          <span class="badge text-bg-secondary">{{len .Items}} Items</span>
        </div>

        {{if not .Items}}
        <p class="text-secondary mb-0">Noch keine Einträge. Leg dein erstes Item an.</p>
        {{else}}
        <ul class="list-group list-group-flush">
          {{range .Items}}
          <li class="list-group-item px-0">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div>
                <p class="fw-semibold mb-1">{{.Title}}</p>
                {{if .Note}}<p class="small text-secondary mb-1">{{.Note}}</p>{{end}}
                {{if .Tags}}<p class="small text-secondary mb-1">Tags: {{.Tags}}</p>{{end}}
                {{if .Link}}<a class="small" href="{{.Link}}" target="_blank" rel="noreferrer">Link öffnen</a>{{end}}
              </div>
              <div class="text-end">
                <span class="badge {{statusBadgeClass .Status}}">{{.Status}}</span>
                {{if .Price}}<p class="small text-secondary mb-0 mt-1">{{.Price}}</p>{{end}}
                <p class="small text-secondary mb-0 mt-1">
                  Kauf erlaubt ab:
                  <time class="purchase-allowed-at" datetime="{{.PurchaseAllowedAt.UTC.Format "2006-01-02T15:04:05Z07:00"}}">{{.PurchaseAllowedAt.Format "02.01.2006 15:04"}}</time>
                </p>
                {{if eq .Status "Kauf erlaubt"}}
                <form method="post" action="/items/status" class="d-flex flex-column gap-1 mt-2">
                  <input type="hidden" name="item_id" value="{{.ID}}" />
                  <button class="btn btn-sm btn-success" type="submit" name="status" value="Gekauft">Als gekauft markieren</button>
                  <button class="btn btn-sm btn-outline-secondary" type="submit" name="status" value="Nicht gekauft">Als nicht gekauft markieren</button>
                </form>
                {{end}}
              </div>
            </div>
          </li>
          {{end}}
        </ul>
        {{end}}
      </div>
    </section>
  </main>

  <script>
    (function () {
      var waitPreset = document.getElementById("wait_preset");
      var customHoursGroup = document.getElementById("custom-hours-group");
      var customHoursInput = document.getElementById("wait_custom_hours");

      function syncCustomHoursVisibility() {
        if (!waitPreset || !customHoursGroup || !customHoursInput) {
          return;
        }

        var isCustom = waitPreset.value === "custom";
        customHoursGroup.hidden = !isCustom;
        customHoursInput.disabled = !isCustom;
      }

      if (waitPreset) {
        waitPreset.addEventListener("change", syncCustomHoursVisibility);
      }
      syncCustomHoursVisibility();

      var formatter = new Intl.DateTimeFormat(navigator.language, {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });

      document.querySelectorAll(".purchase-allowed-at").forEach(function (node) {
        var raw = node.getAttribute("datetime");
        if (!raw) {
          return;
        }

        var parsed = new Date(raw);
        if (Number.isNaN(parsed.getTime())) {
          return;
        }

        node.textContent = formatter.format(parsed);
      });
    })();
  </script>
</body>
</html>
