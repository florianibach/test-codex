{{define "index_content"}}
<section class="card shadow-sm mb-4">
  <div class="card-body d-flex justify-content-between align-items-center gap-3 wrap-sm">
    <div>
      <h1 class="h3 mb-1">Waitlist dashboard</h1>
      <p class="text-secondary mb-0">Park impulse purchases, wait, then decide with a clearer head.</p>
    </div>
    <div class="d-flex gap-2 wrap-sm">
      <a class="btn btn-primary" href="/items/new">Add item</a>
    </div>
  </div>
</section>

<section class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 mb-0">Waitlist</h2>
      <span class="badge text-bg-secondary">{{len .Items}} items</span>
    </div>

    {{if not .Items}}
    <p class="text-secondary mb-0">No entries yet. Add your first item when needed.</p>
    {{else}}
    <ul class="list-group list-group-flush">
      {{range .Items}}
      <li class="list-group-item px-0">
        <div class="d-flex justify-content-between align-items-start gap-3 wrap-sm">
          <div>
            <p class="fw-semibold mb-1">{{.Title}}</p>
            {{if .Note}}<p class="small text-secondary mb-1">{{.Note}}</p>{{end}}
            {{if .Tags}}<p class="small text-secondary mb-1">Tags: {{.Tags}}</p>{{end}}
            {{if .Link}}<a class="small" href="{{.Link}}" target="_blank" rel="noreferrer">Open link</a>{{end}}
          </div>
          <div class="text-end">
            <span class="badge {{statusBadgeClass .Status}}">{{.Status}}</span>
            {{if .Price}}<p class="small text-secondary mb-0 mt-1">{{.Price}}</p>{{end}}
            {{if .Price}}
            {{if workHoursAvailable . $.HourlyWage $.HasHourlyWage}}
            <p class="small text-secondary mb-0 mt-1">Work hours: {{formatWorkHours . $.HourlyWage}} h</p>
            {{else}}
            <p class="small text-secondary mb-0 mt-1">Work hours: add a valid price and hourly wage.</p>
            {{end}}
            {{end}}
            <p class="small text-secondary mb-0 mt-1">
              Buy after:
              <time class="purchase-allowed-at" datetime="{{.PurchaseAllowedAt.UTC.Format "2006-01-02T15:04:05Z07:00"}}">{{.PurchaseAllowedAt.Format "02.01.2006 15:04"}}</time>
            </p>
            <div class="item-actions mt-2">
              <a class="btn btn-sm btn-outline-primary item-action-btn" href="/items/edit?id={{.ID}}">Edit</a>
              <form method="post" action="/items/delete" class="item-status-form" onsubmit="return confirm('Delete this item permanently?');">
                <input type="hidden" name="item_id" value="{{.ID}}" />
                <button class="btn btn-sm btn-outline-danger item-action-btn" type="submit">Delete</button>
              </form>
              {{if or (eq .Status "Waiting") (eq .Status "Ready to buy")}}
              <form method="post" action="/items/snooze" class="item-status-form">
                <input type="hidden" name="item_id" value="{{.ID}}" />
                <button class="btn btn-sm btn-outline-secondary item-action-btn" type="submit" name="snooze_preset" value="24h">Snooze +24h</button>
                <button class="btn btn-sm btn-outline-secondary item-action-btn" type="submit" name="snooze_preset" value="7d">Snooze +7d</button>
                <button class="btn btn-sm btn-outline-secondary item-action-btn" type="submit" name="snooze_preset" value="30d">Snooze +30d</button>
              </form>
              {{end}}
              {{if eq .Status "Ready to buy"}}
              <form method="post" action="/items/status" class="item-status-form">
                <input type="hidden" name="item_id" value="{{.ID}}" />
                <button class="btn btn-sm btn-success item-action-btn" type="submit" name="status" value="Bought">Mark as bought</button>
                <button class="btn btn-sm btn-outline-secondary item-action-btn" type="submit" name="status" value="Skipped">Mark as skipped</button>
              </form>
              {{end}}
            </div>
          </div>
        </div>
      </li>
      {{end}}
    </ul>
    {{end}}
  </div>
</section>
{{end}}

{{define "index_script"}}
<script>
  (function () {
    var formatter = new Intl.DateTimeFormat(navigator.language, {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });

    document.querySelectorAll(".purchase-allowed-at").forEach(function (node) {
      var raw = node.getAttribute("datetime");
      if (!raw) {
        return;
      }

      var parsed = new Date(raw);
      if (Number.isNaN(parsed.getTime())) {
        return;
      }

      node.textContent = formatter.format(parsed);
    });
  })();
</script>
{{end}}
